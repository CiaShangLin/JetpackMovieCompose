name: ðŸ“¦ æ‰‹å‹•ä¸Šå‚³ APK ç™¼å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      changelog:
        description: 'æ›´æ–°èªªæ˜Ž'
        required: true
        type: string
      apk_path:
        description: 'APK æª”æ¡ˆè·¯å¾‘ (ç›¸å°æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„)'
        required: true
        default: 'releases/'
        type: string

jobs:
  manual-release:
    name: ðŸ“¦ æ‰‹å‹•ç™¼å¸ƒ APK
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” é©—è­‰ APK æª”æ¡ˆå­˜åœ¨
        run: |
          APK_PATH="${{ github.event.inputs.apk_path }}"
          if [ ! -f "$APK_PATH"/*.apk ]; then
            echo "âŒ åœ¨ $APK_PATH ç›®éŒ„ä¸­æ‰¾ä¸åˆ° APK æª”æ¡ˆ"
            echo "è«‹ç¢ºä¿å·²å°‡ APK æª”æ¡ˆä¸Šå‚³åˆ°æŒ‡å®šç›®éŒ„"
            exit 1
          fi
          
          APK_FILE=$(find "$APK_PATH" -name "*.apk" | head -1)
          echo "âœ… æ‰¾åˆ° APK æª”æ¡ˆ: $APK_FILE"
          echo "apk_file=$APK_FILE" >> $GITHUB_ENV

      - name: ðŸ·ï¸ å»ºç«‹ç‰ˆæœ¬æ¨™ç±¤
        run: |
          VERSION="${{ github.event.inputs.version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: ðŸ“„ å»ºç«‹ Changelog æª”æ¡ˆ
        run: |
          VERSION="${{ github.event.inputs.version }}"
          CHANGELOG="${{ github.event.inputs.changelog }}"
          
          echo "## ðŸŽ‰ ç‰ˆæœ¬ $VERSION æ›´æ–°å…§å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$CHANGELOG" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "ðŸ“± **APK æª”æ¡ˆï¼š** $(basename ${{ env.apk_file }})" >> CHANGELOG.md
          echo "ðŸ“… **ç™¼å¸ƒæ™‚é–“ï¼š** $(date '+%Y-%m-%d %H:%M:%S')" >> CHANGELOG.md

      - name: ðŸ·ï¸ é‡æ–°å‘½å APK
        run: |
          VERSION="${{ github.event.inputs.version }}"
          OLD_NAME="${{ env.apk_file }}"
          NEW_NAME="JetpackMovieCompose-$VERSION-release.apk"
          
          cp "$OLD_NAME" "$NEW_NAME"
          echo "renamed_apk=$NEW_NAME" >> $GITHUB_ENV

      - name: ðŸŽ‰ å»ºç«‹ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: "ç‰ˆæœ¬ ${{ github.event.inputs.version }}"
          body_path: CHANGELOG.md
          files: ${{ env.renamed_apk }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
